<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Topic — Voix d'Ailleurs</title>
  <link rel="stylesheet" href="style.css?v=2">
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="logo.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .topic-wrap{max-width:900px;margin:2rem auto}
    .card{background:#fff;border:1px solid #e0e0e0;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.05);margin-bottom:1rem}
    .card-header{padding:1rem 1.25rem;border-bottom:1px solid #eee}
    .card-body{padding:1rem 1.25rem}
    .topic-title{font-size:1.4rem;color:#222;margin:0}
    .meta{color:#777;font-size:.9rem}
    .reply{border-top:1px solid #eee;padding:.9rem 0}
    .reply:first-child{border-top:none}
    .new-reply{display:grid;gap:.6rem}
    .new-reply input,.new-reply textarea{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:8px}
    .btn-primary{display:inline-block;background:#ffeecf;color:#444;padding:.7rem 1.1rem;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .btn-primary:hover{background:#ffdca8}
    .back{display:inline-block;margin:1rem 0;color:#00798c;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <div class="container header-wrap">
      <div class="branding">
        <img src="logo.png" alt="Logo Voix d'Ailleurs" class="logo">
        <h1>Voix d'Ailleurs <span class="subtitle">Podcast</span></h1>
      </div>
      <nav>
        <ul class="nav-wrap">
          <li><a href="index.html">Accueil</a></li>
          <li><a href="about.html">À propos</a></li>
          <li><a href="#">Épisodes</a></li>
          <li><a href="#">Ressources</a></li>
          <li><a href="#">Contact</a></li>
          <li><a href="forum.html">Forum</a></li>
        </ul>
      </nav>
      <div class="social-icons">
        <a href="https://www.youtube.com/@SansFrontières-SF" target="_blank" aria-label="YouTube"><i class="fa-brands fa-youtube"></i></a>
        <a href="https://www.tiktok.com/@toncompte" target="_blank" aria-label="TikTok"><i class="fa-brands fa-tiktok"></i></a>
        <a href="https://www.twitch.tv/toncompte" target="_blank" aria-label="Twitch"><i class="fa-brands fa-twitch"></i></a>
        <a href="https://www.facebook.com/tonpage" target="_blank" aria-label="Facebook"><i class="fa-brands fa-facebook"></i></a>
        <a href="https://www.patreon.com/toncompte" target="_blank" aria-label="Patreon"><i class="fa-brands fa-patreon"></i></a>
      </div>
    </div>
  </header>

  <main class="topic-wrap">
    <a class="back" href="forum.html">← Retour au forum</a>

    <section class="card" id="topic-card">
      <div class="card-header">
        <h2 class="topic-title" id="t-title">Chargement…</h2>
        <div class="meta" id="t-meta"></div>
      </div>
      <div class="card-body" id="t-content"></div>
    </section>

    <section class="card">
      <div class="card-header"><h3>Réponses</h3></div>
      <div class="card-body" id="replies"></div>
    </section>

    <section class="card">
      <div class="card-header"><h3>Ajouter une réponse</h3></div>
      <div class="card-body">
        <form class="new-reply" id="reply-form">
          <input type="text" id="r-author" placeholder="Votre nom (optionnel)" />
          <textarea id="r-content" placeholder="Votre message…" required></textarea>
          <button class="btn-primary" type="submit">Publier la réponse</button>
        </form>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Voix d’Ailleurs — Tous droits réservés</p>
    </div>
  </footer>

  <script>
    const SUPABASE_URL = "https://snhadtomnrztwbnludko.supabase.co";       // ← remplace
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuaGFkdG9tbnJ6dHdibmx1ZGtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTMyNzcsImV4cCI6MjA3MjU2OTI3N30.2NETqi1UBU6wlVasIHDu5Fv8NVSu5m1KN3CR1vwgKnc";                      // ← remplace
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const qs = new URLSearchParams(location.search);
    const topicId = qs.get('id');

    const tTitle = document.getElementById('t-title');
    const tMeta  = document.getElementById('t-meta');
    const tCont  = document.getElementById('t-content');
    const repliesBox = document.getElementById('replies');

    function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function fmtDate(iso){ return new Date(iso).toLocaleString('fr-FR', { dateStyle:'medium', timeStyle:'short' }); }

    async function loadTopic(){
      if(!topicId){ tTitle.textContent="Sujet introuvable"; return; }

      const { data:topic, error } = await db.from('topics').select('*').eq('id', topicId).single();
      if(error || !topic){ tTitle.textContent="Sujet introuvable"; return; }

      tTitle.textContent = topic.title;
      tMeta.textContent  = `${topic.category} — par ${topic.author || 'Invité'} • ${fmtDate(topic.created_at)}`;
      tCont.innerHTML    = esc(topic.content).replace(/\n/g,'<br>');

      await loadReplies();
    }

    async function loadReplies(){
      const { data, error } = await db.from('replies')
        .select('*').eq('topic_id', topicId).order('created_at', { ascending: true });
      repliesBox.innerHTML = '';
      if(error){ repliesBox.textContent = "Erreur de chargement."; return; }
      if(!data.length){ repliesBox.innerHTML = '<p class="meta">Aucune réponse pour le moment.</p>'; return; }
      for(const r of data){
        const div = document.createElement('div');
        div.className = 'reply';
        div.innerHTML = `<div class="meta"><strong>${esc(r.author||'Invité')}</strong> — ${fmtDate(r.created_at)}</div>
                         <div>${esc(r.content).replace(/\n/g,'<br>')}</div>`;
        repliesBox.appendChild(div);
      }
    }

    document.getElementById('reply-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const content = document.getElementById('r-content').value.trim();
      const author  = document.getElementById('r-author').value.trim() || null;
      if(!content) return;

      const { error } = await db.from('replies').insert({ topic_id: topicId, content, author });
      if(error){ alert("Erreur: " + error.message); return; }
      document.getElementById('r-content').value='';
      await loadReplies();
    });

    loadTopic();
  </script>
</body>
</html>
